/**
 * Commande help
 * Affiche la liste des commandes disponibles avec pagination par cat√©gorie
 */

const {
    EmbedBuilder,
    ActionRowBuilder,
    ButtonBuilder,
    StringSelectMenuBuilder,
    ButtonStyle,
    version: discordVersion
} = require('discord.js');
const fs = require('fs');
const path = require('path');
const os = require('os');

module.exports = {
    name: 'help',
    description: 'Affiche la liste des commandes disponibles',
    category: 'Utilitaires',
    usage: 'help [commande/cat√©gorie]',
    examples: ['help', 'help ping', 'help everyone'],
    aliases: ['aide', 'commands', 'cmds', 'h'],
    cooldown: 3,

    /**
     * Ex√©cute la commande help
     * @param {Client} client - Instance du client Discord
     * @param {Message} message - Message de l'utilisateur
     * @param {Array} args - Arguments de la commande
     */
    async run(client, message, args) {
        try {
            // Message de chargement
            const loadingEmbed = new EmbedBuilder()
                .setColor(client.config.embed.color)
                .setDescription("üîç **Chargement du menu d'aide...**");

            const loadingMsg = await message.reply({ embeds: [loadingEmbed] });

            // R√©cup√©rer le pr√©fixe du serveur
            const prefix = await client.getPrefix(message.guild?.id);

            // Si un argument est fourni, afficher l'aide pour cette commande ou cat√©gorie sp√©cifique
            if (args.length) {
                return handleSpecificHelp(client, message, args[0], loadingMsg, prefix);
            }

            // Afficher le menu d'aide g√©n√©ral
            await displayHelpMenu(client, message, loadingMsg, prefix);
        } catch (error) {
            console.error('Erreur dans la commande help:', error);
            message.reply('Une erreur est survenue lors de l\'affichage du menu d\'aide.');
        }
    }
};

/**
 * R√©cup√®re les statistiques du bot
 * @param {Client} client - Instance du client Discord
 * @returns {Object} - Statistiques du bot
 */
function getBotStats(client) {
    const uptime = client.uptime;
    const days = Math.floor(uptime / 86400000);
    const hours = Math.floor(uptime / 3600000) % 24;
    const minutes = Math.floor(uptime / 60000) % 60;
    const seconds = Math.floor(uptime / 1000) % 60;

    return {
        servers: client.guilds.cache.size,
        users: client.guilds.cache.reduce((acc, guild) => acc + guild.memberCount, 0),
        channels: client.channels.cache.size,
        commands: client.commands.size,
        uptime: `${days}j ${hours}h ${minutes}m ${seconds}s`,
        ping: `${client.ws.ping}ms`,
        memory: `${(process.memoryUsage().heapUsed / 1024 / 1024).toFixed(2)} MB`,
        cpu: `${os.loadavg()[0].toFixed(2)}%`,
        version: '1.0.0',
        discord: discordVersion,
        node: process.version
    };
}

/**
 * Organise les commandes par cat√©gorie
 * @param {Client} client - Instance du client Discord
 * @returns {Object} - Commandes organis√©es par cat√©gorie
 */
function organizeCommandsByCategory(client) {
    const organizedCommands = {};

    // Obtenir toutes les commandes
    client.commands.forEach(cmd => {
        // Utiliser la cat√©gorie de la commande, ou 'Non cat√©goris√©' si non d√©finie
        const category = cmd.category || 'Non cat√©goris√©';

        // Cr√©er la cat√©gorie si elle n'existe pas encore
        if (!organizedCommands[category]) {
            organizedCommands[category] = [];
        }

        // Ajouter la commande √† sa cat√©gorie
        organizedCommands[category].push(cmd);
    });

    return organizedCommands;
}

/**
 * Affiche le menu d'aide principal avec les cat√©gories
 * @param {Client} client - Instance du client Discord
 * @param {Message} message - Message de l'utilisateur
 * @param {Message} loadingMsg - Message de chargement √† √©diter
 * @param {String} prefix - Pr√©fixe du serveur
 */
async function displayHelpMenu(client, message, loadingMsg, prefix) {
    try {
        // Organiser les commandes par cat√©gorie
        const commandsByCategory = organizeCommandsByCategory(client);

        // R√©cup√©rer les cat√©gories (maintenant bas√©es sur les cat√©gories des commandes et non les dossiers)
        const categories = Object.keys(commandsByCategory).sort();

        // Cr√©er un syst√®me de pagination pour naviguer entre les cat√©gories
        let currentPage = 0;
        const embeds = [];

        // --- PAGE D'ACCUEIL ---
        const stats = getBotStats(client);
        const homeEmbed = new EmbedBuilder()
            .setColor(client.config.embed.color)
            .setAuthor({
                name: `${client.user.username} ‚Ä¢ Centre d'Aide`,
                iconURL: client.user.displayAvatarURL()
            })
            .setDescription([
                `üìå Bienvenue dans l'interface d'aide de **${client.user.username}**`,
                'Retrouvez ci-dessous toutes les informations n√©cessaires √† l\'utilisation du bot.',
                '',
                '**üìã Navigation & Utilisation**',
                '> ‚Ä¢ Utilisez les boutons pour parcourir les pages',
                '> ‚Ä¢ S√©lectionnez une cat√©gorie via le menu d√©roulant',
                '> ‚Ä¢ La session expire apr√®s 2 minutes d\'inactivit√©',
                '',
                '**üîç Recherche Rapide**',
                `> ‚Ä¢ \`${prefix}help <commande>\` - D√©tails d'une commande`,
                `> ‚Ä¢ \`${prefix}help <cat√©gorie>\` - Liste des commandes par cat√©gorie`,
                '',
                '**üìä Statistiques**',
                `> ‚Ä¢ Serveurs : \`${stats.servers.toLocaleString()}\``,
                `> ‚Ä¢ Utilisateurs : \`${stats.users.toLocaleString()}\``,
                `> ‚Ä¢ Commandes : \`${stats.commands}\``,
                `> ‚Ä¢ Cat√©gories : \`${categories.length}\``,
                `> ‚Ä¢ Uptime : \`${stats.uptime}\``,
                `> ‚Ä¢ Latence : \`${stats.ping}\``,
                '',
                '**üîß Syst√®me**',
                `> ‚Ä¢ Version : \`${stats.version}\``,
                `> ‚Ä¢ Discord.js : \`${stats.discord}\``,
                `> ‚Ä¢ Node.js : \`${stats.node}\``,
                `> ‚Ä¢ M√©moire : \`${stats.memory}\``,
                `> ‚Ä¢ CPU : \`${stats.cpu}\``,
                '',
                '**üîó Liens Importants**',
                `> ‚Ä¢ [Inviter ${client.user.username}](https://discord.com/oauth2/authorize?client_id=${client.user.id}&scope=bot&permissions=8)`,
                '',
                '*S√©lectionnez une cat√©gorie ci-dessous pour commencer.*'
            ].join('\n'));

        embeds.push(homeEmbed);

        // --- PAGE D√âVELOPPEUR ---
        if (client.config.developers && client.config.developers.length > 0) {
            const devId = client.config.developers[0];
            const developer = await client.users.fetch(devId).catch(() => null);

            if (developer) {
                const devEmbed = new EmbedBuilder()
                    .setColor(client.config.embed.color)
                    .setAuthor({
                        name: `${client.user.username} ‚Ä¢ D√©veloppeur`,
                        iconURL: client.user.displayAvatarURL()
                    })
                    .setDescription([
                        '**üë®‚Äçüíª Informations sur le D√©veloppeur**',
                        '',
                        '**üîß Profil**',
                        `> ‚Ä¢ D√©veloppeur : \`${developer.tag}\``,
                        `> ‚Ä¢ ID : \`${developer.id}\``,
                        `> ‚Ä¢ Cr√©ation : <t:${Math.floor(developer.createdTimestamp / 1000)}:R>`,
                        '',
                        '**üõ†Ô∏è D√©veloppement**',
                        '> ‚Ä¢ Langage : `JavaScript`',
                        '> ‚Ä¢ Framework : `Discord.js v14`',
                        '> ‚Ä¢ Base de donn√©es : `MongoDB`',
                        '',
                        '*Pour toute question ou suggestion, rejoignez le serveur support.*'
                    ].join('\n'))
                    .setThumbnail(developer.displayAvatarURL({ dynamic: true }));

                embeds.push(devEmbed);
            }
        }

        // --- PAGES DES CAT√âGORIES ---
        for (const category of categories) {
            const commands = commandsByCategory[category];

            // Formater le nom de la cat√©gorie (premi√®re lettre en majuscule)
            const formattedCategory = category.charAt(0).toUpperCase() + category.slice(1);

            const categoryEmbed = new EmbedBuilder()
                .setColor(client.config.embed.color)
                .setAuthor({
                    name: `${client.user.username} ‚Ä¢ ${formattedCategory}`,
                    iconURL: client.user.displayAvatarURL()
                })
                .setDescription([
                    `**üìë Commandes de la cat√©gorie ${formattedCategory}**`,
                    'Retrouvez ci-dessous toutes les commandes disponibles dans cette cat√©gorie.',
                    '',
                    `*Pr√©fixe actuel : \`${prefix}\`*`,
                    `*Tapez \`${prefix}help <commande>\` pour plus de d√©tails sur une commande*`,
                    ''
                ].join('\n'));

            // Diviser les commandes en groupes pour une meilleure pr√©sentation
            const commandsPerGroup = 6;

            for (let i = 0; i < commands.length; i += commandsPerGroup) {
                const groupCommands = commands.slice(i, i + commandsPerGroup);
                let fieldValue = '';

                for (const cmd of groupCommands) {
                    fieldValue += `\`${prefix}${cmd.name}\`\n`;
                    fieldValue += `> ${cmd.description || "Aucune description"}\n`;
                    if (cmd.aliases && cmd.aliases.length) {
                        fieldValue += `> Aliases : \`${cmd.aliases.join('`, `')}\`\n`;
                    }
                    fieldValue += '\n';
                }

                categoryEmbed.addFields({
                    name: `üìÅ Groupe ${Math.floor(i / commandsPerGroup) + 1}`,
                    value: fieldValue,
                    inline: false
                });
            }

            embeds.push(categoryEmbed);
        }

        // --- CR√âATION DES COMPOSANTS D'INTERFACE ---

        // Menu de s√©lection
        const selectMenuOptions = [
            {
                label: 'Accueil',
                description: 'Retourner √† la page d\'accueil',
                value: '0',
                emoji: 'üè†',
                default: currentPage === 0
            }
        ];

        // Ajouter l'option D√©veloppeur si disponible
        if (embeds.length > 1 && client.config.developers && client.config.developers.length > 0) {
            selectMenuOptions.push({
                label: 'D√©veloppeur',
                description: 'Informations sur le d√©veloppeur',
                value: '1',
                emoji: 'üë®‚Äçüíª',
                default: currentPage === 1
            });
        }

        // Ajouter les options pour chaque cat√©gorie
        categories.forEach((category, index) => {
            const offset = client.config.developers && client.config.developers.length > 0 ? 2 : 1;
            selectMenuOptions.push({
                label: category.charAt(0).toUpperCase() + category.slice(1),
                description: `Voir les commandes de la cat√©gorie ${category}`,
                value: (index + offset).toString(),
                emoji: getCategoryEmoji(category),
                default: currentPage === (index + offset)
            });
        });

        const selectMenu = new ActionRowBuilder().addComponents(
            new StringSelectMenuBuilder()
                .setCustomId('category_select')
                .setPlaceholder('üìë S√©lectionnez une page')
                .addOptions(selectMenuOptions)
        );

        // Boutons de navigation
        const buttons = new ActionRowBuilder().addComponents(
            new ButtonBuilder()
                .setCustomId('first')
                .setEmoji('‚èÆÔ∏è')
                .setStyle(ButtonStyle.Secondary)
                .setDisabled(currentPage === 0),
            new ButtonBuilder()
                .setCustomId('prev')
                .setEmoji('‚óÄÔ∏è')
                .setStyle(ButtonStyle.Primary)
                .setDisabled(currentPage === 0),
            new ButtonBuilder()
                .setCustomId('home')
                .setEmoji('üè†')
                .setStyle(ButtonStyle.Success)
                .setDisabled(currentPage === 0),
            new ButtonBuilder()
                .setCustomId('next')
                .setEmoji('‚ñ∂Ô∏è')
                .setStyle(ButtonStyle.Primary)
                .setDisabled(currentPage === embeds.length - 1),
            new ButtonBuilder()
                .setCustomId('last')
                .setEmoji('‚è≠Ô∏è')
                .setStyle(ButtonStyle.Secondary)
                .setDisabled(currentPage === embeds.length - 1)
        );

        // Mettre √† jour le message de chargement avec les embeds et composants
        await loadingMsg.edit({
            embeds: [embeds[currentPage]],
            components: [selectMenu, buttons]
        });

        // --- GESTION DES INTERACTIONS ---

        // Cr√©er un collecteur pour les interactions avec les composants
        const collector = loadingMsg.createMessageComponentCollector({
            time: 120000 // 2 minutes
        });

        collector.on('collect', async interaction => {
            // V√©rifier que c'est bien l'auteur du message qui interagit
            if (interaction.user.id !== message.author.id) {
                return interaction.reply({
                    content: 'Ces contr√¥les ne sont pas pour vous!',
                    ephemeral: true
                });
            }

            // Diff√©rer la mise √† jour pour √©viter les erreurs
            await interaction.deferUpdate();

            // Traitement diff√©rent selon le type d'interaction
            if (interaction.isButton()) {
                switch (interaction.customId) {
                    case 'first': currentPage = 0; break;
                    case 'prev': currentPage = Math.max(0, currentPage - 1); break;
                    case 'next': currentPage = Math.min(embeds.length - 1, currentPage + 1); break;
                    case 'last': currentPage = embeds.length - 1; break;
                    case 'home': currentPage = 0; break;
                }
            } else if (interaction.isStringSelectMenu()) {
                if (interaction.customId === 'category_select') {
                    currentPage = parseInt(interaction.values[0]);
                }
            }

            // Mettre √† jour les boutons
            buttons.components[0].setDisabled(currentPage === 0); // First
            buttons.components[1].setDisabled(currentPage === 0); // Previous
            buttons.components[2].setDisabled(currentPage === 0); // Home
            buttons.components[3].setDisabled(currentPage === embeds.length - 1); // Next
            buttons.components[4].setDisabled(currentPage === embeds.length - 1); // Last

            // Mettre √† jour le menu d√©roulant
            selectMenu.components[0].options.forEach((option, index) => {
                option.default = index.toString() === currentPage.toString();
            });

            // Mettre √† jour le message
            await loadingMsg.edit({
                embeds: [embeds[currentPage]],
                components: [selectMenu, buttons]
            });
        });

        collector.on('end', () => {
            // D√©sactiver tous les composants √† la fin du temps imparti
            const disabledButtons = new ActionRowBuilder().addComponents(
                buttons.components.map(button =>
                    ButtonBuilder.from(button).setDisabled(true)
                )
            );

            const disabledSelectMenu = new ActionRowBuilder().addComponents(
                StringSelectMenuBuilder.from(selectMenu.components[0])
                    .setDisabled(true)
                    .setPlaceholder('Session expir√©e')
            );

            loadingMsg.edit({
                components: [disabledSelectMenu, disabledButtons]
            }).catch(() => { });
        });

    } catch (error) {
        console.error('Erreur dans le menu d\'aide:', error);
        loadingMsg.edit({
            embeds: [
                new EmbedBuilder()
                    .setColor("#e74c3c")
                    .setTitle("‚ùå Erreur")
                    .setDescription("Une erreur est survenue lors de l'affichage du menu d'aide.")
            ]
        });
    }
}

/**
 * G√®re l'affichage de l'aide pour une commande ou cat√©gorie sp√©cifique
 * @param {Client} client - Instance du client Discord
 * @param {Message} message - Message de l'utilisateur
 * @param {string} query - Nom de la commande ou cat√©gorie
 * @param {Message} loadingMsg - Message de chargement √† √©diter
 * @param {String} prefix - Pr√©fixe du serveur
 */
async function handleSpecificHelp(client, message, query, loadingMsg, prefix) {
    // Organiser les commandes par cat√©gorie pour rechercher les cat√©gories
    const commandsByCategory = organizeCommandsByCategory(client);
    const categories = Object.keys(commandsByCategory);

    // V√©rifier si c'est une commande
    const command = client.commands.get(query.toLowerCase()) ||
        client.commands.find(cmd => cmd.aliases && cmd.aliases.includes(query.toLowerCase()));

    if (command) {
        // C'est une commande, afficher son aide sp√©cifique
        const commandEmbed = new EmbedBuilder()
            .setColor(client.config.embed.color)
            .setAuthor({
                name: `üìö Aide ‚Ä¢ ${command.name}`,
                iconURL: client.user.displayAvatarURL()
            })
            .setDescription([
                `\`\`\`md\n# ${command.name}\n\`\`\``,
                '**üìù Informations :**',
                `> üìã Description : ${command.description || 'Aucune description disponible'}`,
                `> üìÇ Cat√©gorie : ${command.category ? command.category.charAt(0).toUpperCase() + command.category.slice(1) : 'Non cat√©goris√©'}`,
                `> üí≠ Aliases : ${command.aliases ? `\`${command.aliases.join('`, `')}\`` : 'Aucun alias'}`,
                `> üìú Utilisation : \`${prefix}${command.usage || command.name}\``,
                `> ‚è±Ô∏è Cooldown : ${command.cooldown || '3'} secondes`,
                command.permissions ? `> üîí Permissions : \`${command.permissions.join('`, `')}\`` : null,
                '',
                '*Pour plus d\'informations, rejoignez le serveur support.*'
            ].filter(Boolean).join('\n'))
            .setThumbnail(client.user.displayAvatarURL({ dynamic: true }));

        // Bouton pour retourner au menu principal
        const row = new ActionRowBuilder()
            .addComponents(
                new ButtonBuilder()
                    .setCustomId('back_to_help')
                    .setLabel('Retour au menu d\'aide')
                    .setEmoji('üîô')
                    .setStyle(ButtonStyle.Secondary)
            );

        await loadingMsg.edit({
            embeds: [commandEmbed],
            components: [row]
        });

        // Collecteur pour le bouton de retour
        const collector = loadingMsg.createMessageComponentCollector({
            time: 60000 // 1 minute
        });

        collector.on('collect', async interaction => {
            if (interaction.user.id !== message.author.id) {
                return interaction.reply({
                    content: 'Ce bouton n\'est pas pour vous!',
                    ephemeral: true
                });
            }

            if (interaction.customId === 'back_to_help') {
                collector.stop();
                await displayHelpMenu(client, message, loadingMsg, prefix);
            }
        });

        collector.on('end', () => {
            const disabledRow = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('back_to_help')
                        .setLabel('Retour au menu d\'aide')
                        .setEmoji('üîô')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true)
                );

            loadingMsg.edit({ components: [disabledRow] }).catch(() => { });
        });

        return;
    }

    // V√©rifier si c'est une cat√©gorie
    const categoryMatch = categories.find(cat => cat.toLowerCase() === query.toLowerCase());

    if (categoryMatch) {
        const commands = commandsByCategory[categoryMatch];

        // Formater le nom de la cat√©gorie (premi√®re lettre en majuscule)
        const formattedCategory = categoryMatch.charAt(0).toUpperCase() + categoryMatch.slice(1);

        const categoryEmbed = new EmbedBuilder()
            .setColor(client.config.embed.color)
            .setAuthor({
                name: `${client.user.username} ‚Ä¢ ${formattedCategory}`,
                iconURL: client.user.displayAvatarURL()
            })
            .setDescription([
                `**üìë Commandes de la cat√©gorie ${formattedCategory}**`,
                'Retrouvez ci-dessous toutes les commandes disponibles dans cette cat√©gorie.',
                '',
                `*Pr√©fixe actuel : \`${prefix}\`*`,
                `*Tapez \`${prefix}help <commande>\` pour plus de d√©tails sur une commande*`,
                ''
            ].join('\n'));

        // Diviser les commandes en groupes pour une meilleure pr√©sentation
        const commandsPerGroup = 6;

        for (let i = 0; i < commands.length; i += commandsPerGroup) {
            const groupCommands = commands.slice(i, i + commandsPerGroup);
            let fieldValue = '';

            for (const cmd of groupCommands) {
                fieldValue += `\`${prefix}${cmd.name}\`\n`;
                fieldValue += `> ${cmd.description || "Aucune description"}\n`;
                if (cmd.aliases && cmd.aliases.length) {
                    fieldValue += `> Aliases : \`${cmd.aliases.join('`, `')}\`\n`;
                }
                fieldValue += '\n';
            }

            categoryEmbed.addFields({
                name: `üìÅ Groupe ${Math.floor(i / commandsPerGroup) + 1}`,
                value: fieldValue,
                inline: false
            });
        }

        // Bouton pour retourner au menu principal
        const row = new ActionRowBuilder()
            .addComponents(
                new ButtonBuilder()
                    .setCustomId('back_to_help')
                    .setLabel('Retour au menu d\'aide')
                    .setEmoji('üîô')
                    .setStyle(ButtonStyle.Secondary)
            );

        await loadingMsg.edit({
            embeds: [categoryEmbed],
            components: [row]
        });

        // Collecteur pour le bouton de retour
        const collector = loadingMsg.createMessageComponentCollector({
            time: 60000 // 1 minute
        });

        collector.on('collect', async interaction => {
            if (interaction.user.id !== message.author.id) {
                return interaction.reply({
                    content: 'Ce bouton n\'est pas pour vous!',
                    ephemeral: true
                });
            }

            if (interaction.customId === 'back_to_help') {
                collector.stop();
                await displayHelpMenu(client, message, loadingMsg, prefix);
            }
        });

        collector.on('end', () => {
            const disabledRow = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('back_to_help')
                        .setLabel('Retour au menu d\'aide')
                        .setEmoji('üîô')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true)
                );

            loadingMsg.edit({ components: [disabledRow] }).catch(() => { });
        });

        return;
    }

    // Ni commande ni cat√©gorie trouv√©e
    await loadingMsg.edit({
        embeds: [
            new EmbedBuilder()
                .setColor("#e67e22")
                .setAuthor({
                    name: '‚ùå Non trouv√©',
                    iconURL: message.author.displayAvatarURL({ dynamic: true })
                })
                .setDescription([
                    `\`${query}\` n'est ni une commande ni une cat√©gorie valide.`,
                    '',
                    '**üìã Cat√©gories disponibles :**',
                    categories.map(cat => `> ‚Ä¢ ${cat.charAt(0).toUpperCase() + cat.slice(1)}`).join('\n'),
                    '',
                    `*Tapez \`${prefix}help\` pour voir toutes les commandes.*`
                ].join('\n'))
        ]
    });

    // Attendre 5 secondes puis afficher le menu d'aide g√©n√©ral
    setTimeout(async () => {
        await displayHelpMenu(client, message, loadingMsg, prefix);
    }, 5000);
}

/**
 * Obtient l'emoji correspondant √† une cat√©gorie
 * @param {string} category - Nom de la cat√©gorie
 * @returns {string} - Emoji correspondant
 */
function getCategoryEmoji(category) {
    const categoryEmojis = {
        'everyone': 'üë•',
        'utilitaires': 'üõ†Ô∏è',
        'utility': 'üõ†Ô∏è',
        'moderation': 'üî®',
        'fun': 'üéÆ',
        'music': 'üéµ',
        'games': 'üé≤',
        'economy': 'üí∞',
        'administration': '‚öôÔ∏è',
        'owners': 'üëë',
        'owner': 'üëë',
        'developers': 'üë®‚Äçüíª',
        'information': '‚ÑπÔ∏è',
        'giveaway': 'üéâ',
        'settings': '‚öôÔ∏è'
    };

    return categoryEmojis[category.toLowerCase()] || 'üìÅ';
}